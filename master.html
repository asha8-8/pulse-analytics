<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Panel - PULSE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .master-badge {
            background: #ff9800;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .welcome-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .welcome-card h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .master-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .master-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e9ecef;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .master-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff9800, #ffc107);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .master-card:hover::before {
            transform: scaleX(1);
        }

        .master-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(255, 152, 0, 0.2);
            border-color: #ff9800;
        }

        .master-card h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .master-card .icon {
            font-size: 32px;
            transition: transform 0.3s ease;
        }

        .master-card:hover .icon {
            transform: scale(1.15) rotate(5deg);
        }

        .master-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .master-card button {
            margin-top: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .master-card button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 30px;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #e7f3ff;
        }

        .upload-area.drag-over {
            border-color: #28a745;
            background: #d4edda;
        }

        .file-list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .file-list-table th,
        .file-list-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .file-list-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .file-list-table tr:hover {
            background: #f8f9fa;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-download {
            background: #28a745;
            color: white;
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #ff9800;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div style="display: flex; align-items: center; gap: 12px;">
            <svg width="35" height="35" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="masterLogoGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.9" />
                        <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="42" fill="none" stroke="white" stroke-width="1.5" opacity="0.3"/>
                <path d="M 12,50 Q 18,35 24,50 T 36,50 Q 42,65 48,50" fill="none" stroke="white" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
                <path d="M 30,50 Q 36,26 42,50 T 54,50 Q 60,20 66,50 T 78,50" fill="none" stroke="url(#masterLogoGradient)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M 52,50 Q 58,65 64,50 T 76,50 Q 82,35 88,50" fill="none" stroke="#f093fb" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
                <circle cx="50" cy="50" r="7" fill="white"/>
                <circle cx="50" cy="50" r="4" fill="#764ba2"/>
                <circle cx="50" cy="15" r="3.5" fill="white" opacity="0.9"/>
                <circle cx="85" cy="50" r="3.5" fill="white" opacity="0.9"/>
                <circle cx="50" cy="85" r="3.5" fill="#f093fb" opacity="0.9"/>
                <circle cx="15" cy="50" r="3.5" fill="white" opacity="0.9"/>
            </svg>
            <h1>PULSE Master Panel</h1>
        </div>
        <div class="user-info">
            <span class="master-badge">MASTER</span>
            <span id="userName">Master User</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="welcome-card">
            <h2>Welcome, Master!</h2>
            <p>You are logged in as a Master User. You can upload data, manage dashboards, and publish analytics.</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Published Dashboards</h3>
                <div class="number">8</div>
            </div>
            <div class="stat-card">
                <h3>Data Uploads</h3>
                <div class="number">24</div>
            </div>
            <div class="stat-card">
                <h3>Active Templates</h3>
                <div class="number">15</div>
            </div>
            <div class="stat-card">
                <h3>Business Users</h3>
                <div class="number">3</div>
            </div>
        </div>

        <div class="master-grid">
            <div class="master-card">
                <h3><span class="icon">üì§</span>Upload Data</h3>
                <p>Upload CSV/Excel files to generate beautiful dashboards automatically. Supported formats: .csv, .xlsx, .xls</p>
                <button onclick="openUploadModal()">Upload File</button>
            </div>

            <div class="master-card">
                <h3><span class="icon">üé®</span>Select Template</h3>
                <p>Choose from pre-designed dashboard templates for Procurement, Finance, Warehouse, HR, and more.</p>
                <button onclick="alert('Template selection coming soon!')">Browse Templates</button>
            </div>

            <div class="master-card">
                <h3><span class="icon">üìä</span>Manage Dashboards</h3>
                <p>View, edit, and publish your dashboards. Control which users have access to each dashboard.</p>
                <button onclick="alert('Dashboard management coming soon!')">Manage</button>
            </div>

            <div class="master-card">
                <h3><span class="icon">üîÑ</span>Data Refresh</h3>
                <p>Schedule automatic data refreshes or trigger manual updates to keep your dashboards current.</p>
                <button onclick="alert('Refresh settings coming soon!')">Configure</button>
            </div>

            <div class="master-card">
                <h3><span class="icon">üë•</span>User Access</h3>
                <p>Assign dashboard access to business users. Control who can view specific analytics and reports.</p>
                <button onclick="openManageAccessModal()">Manage Access</button>
            </div>

            <div class="master-card">
                <h3><span class="icon">üìà</span>Analytics Report</h3>
                <p>View usage statistics, track dashboard performance, and see which reports are most popular.</p>
                <button onclick="alert('Analytics report coming soon!')">View Report</button>
            </div>
        </div>
    </div>

    <!-- Manage Access Modal -->
    <div id="manageAccessModal" class="modal">
        <div class="modal-content" style="max-width: 1100px;">
            <div class="modal-header">
                <div>
                    <h2 style="margin: 0 0 8px 0;">üìÅ File Explorer - Manage Access</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">Browse and assign files to Business Users</p>
                </div>
                <span class="close" onclick="closeManageAccessModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 0;">

                <!-- File Explorer Header -->
                <div style="background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6;">
                    <!-- Breadcrumb Navigation -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <button id="backButton" onclick="showFolderView()" style="display: none; padding: 6px 12px; background: white; border: 1px solid #ced4da; border-radius: 6px; cursor: pointer; font-size: 13px; margin-right: 10px;">‚Üê Back</button>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="#666">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                        </svg>
                        <span style="color: #999; font-size: 13px;">This PC</span>
                        <span style="color: #ccc;">‚Ä∫</span>
                        <span style="color: #666; font-size: 13px; font-weight: 500;">PULSE-Prototype</span>
                        <span id="breadcrumbUploads" style="display: none;">
                            <span style="color: #ccc;">‚Ä∫</span>
                            <span style="color: #667eea; font-size: 13px; font-weight: 600;">uploads</span>
                        </span>
                    </div>
                    
                    <!-- Toolbar -->
                    <div id="fileToolbar" style="display: none; gap: 10px; align-items: center;">
                        <input type="text" id="accessSearchInput" placeholder="üîç Search in uploads..." onkeyup="filterAccessFiles()" style="flex: 1; max-width: 350px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px;">
                        <select id="accessFilterSelect" onchange="filterAccessFiles()" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; background: white;">
                            <option value="all">All Files</option>
                            <option value="unassigned">‚ö†Ô∏è Unassigned</option>
                            <option value="SCD_CIS">Assigned to SCD_CIS</option>
                            <option value="SCD_PUR">Assigned to SCD_PUR</option>
                            <option value="SCD_WHS">Assigned to SCD_WHS</option>
                            <option value="SCD_SRM">Assigned to SCD_SRM</option>
                            <option value="SCD_MGR">Assigned to SCD_MGR</option>
                            <option value="all_users">All Users</option>
                        </select>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 12px; color: #666;" id="folderFileCount">0 items</span>
                            <input type="file" id="addFilesInput" multiple accept=".xlsx,.xls,.csv,.html,.pdf,.txt,.json" style="display: none;" onchange="handleFolderSelect(this.files)">
                            <button onclick="document.getElementById('addFilesInput').click()" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">‚ûï Add Files</button>
                            <button onclick="exportAllFiles()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">üì¶ Export All</button>
                        </div>
                    </div>
                </div>

                <!-- Storage Info Bar -->
                <div id="storageBar_container" style="display: none; background: white; padding: 10px 20px; border-bottom: 1px solid #dee2e6; align-items: center; gap: 15px; font-size: 12px; color: #666;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="#666">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        <span id="storageUsed">0 MB</span>
                        <span style="color: #999;">used</span>
                    </div>
                    <div style="flex: 1; max-width: 200px; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                        <div id="storageBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                    </div>
                    <span style="color: #999;" id="storagePercent">0%</span>
                </div>

                <!-- Folder View -->
                <div id="folderView" style="padding: 20px; min-height: 400px;">
                    <div style="text-align: center; padding: 40px 20px;">
                        <h3 style="color: #666; margin-bottom: 20px; font-size: 16px;">Folders in PULSE-Prototype</h3>
                        <div onclick="showFileView()" style="display: inline-flex; flex-direction: column; align-items: center; gap: 10px; padding: 30px 40px; background: white; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.15)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="#FFC107">
                                <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                            </svg>
                            <div style="font-size: 15px; font-weight: 600; color: #333;">üìÅ uploads</div>
                            <div style="font-size: 12px; color: #999;" id="folderItemCount">0 items</div>
                        </div>
                    </div>
                </div>

                <!-- File Explorer List View -->
                <div id="fileView" style="display: none; padding: 20px; min-height: 400px;">
                    
                    <!-- Column Headers -->
                    <div style="display: grid; grid-template-columns: 45% 15% 10% 15% 15%; padding: 10px 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 10px; font-size: 12px; font-weight: 600; color: #666;">
                        <div>üìÑ Name</div>
                        <div>üìã Category</div>
                        <div>üíæ Size</div>
                        <div>üë• Access</div>
                        <div>üìÖ Modified</div>
                    </div>

                    <!-- Files List -->
                    <div id="accessTableBody">
                        <!-- Files will be listed here -->
                    </div>

                    <!-- Empty State -->
                    <div id="accessEmptyState" style="display: none; text-align: center; padding: 80px 20px; color: #999;">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="#ddd" style="margin-bottom: 20px;">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                        </svg>
                        <h3 style="color: #999; margin-bottom: 10px; font-size: 18px;">uploads folder is empty</h3>
                        <p style="color: #bbb; font-size: 14px;">Upload files to get started</p>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- Edit Access Modal -->
    <div id="editAccessModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div>
                    <h2 style="margin: 0 0 8px 0;">‚úèÔ∏è Assign File Access</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;" id="editAccessFileName"></p>
                </div>
                <span class="close" onclick="closeEditAccessModal()">&times;</span>
            </div>
            <div class="modal-body">

                <!-- File Location Display -->
                <div style="background: #e7f3ff; border: 1px solid #0066cc; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #004085; font-family: monospace;" id="editAccessFilePath">
                        üìÅ PULSE-Prototype/uploads/filename.xlsx
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #666;">Assign to Business Users:</h3>
                    
                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; cursor: pointer; border: 2px solid transparent;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='transparent'">
                        <input type="checkbox" id="editAssignAll" onchange="toggleAllUsersEdit()" style="width: 20px; height: 20px; cursor: pointer;">
                        <div>
                            <div style="font-size: 15px; font-weight: 600; color: #333;">All Business Users</div>
                            <div style="font-size: 12px; color: #666;">Grant access to all current and future Business Users</div>
                        </div>
                    </label>

                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" class="editUserCheckbox" value="SCD_CIS" style="width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: #333;">SCD_CIS</div>
                                <div style="font-size: 12px; color: #666;">Business User - CIS</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" class="editUserCheckbox" value="SCD_PUR" style="width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: #333;">SCD_PUR</div>
                                <div style="font-size: 12px; color: #666;">Business User - PUR</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" class="editUserCheckbox" value="SCD_WHS" style="width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: #333;">SCD_WHS</div>
                                <div style="font-size: 12px; color: #666;">Business User - WHS</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" class="editUserCheckbox" value="SCD_SRM" style="width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: #333;">SCD_SRM</div>
                                <div style="font-size: 12px; color: #666;">Business User - SRM</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" class="editUserCheckbox" value="SCD_MGR" style="width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-size: 14px; font-weight: 500; color: #333;">SCD_MGR</div>
                                <div style="font-size: 12px; color: #666;">Business User - MGR</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Update Frequency Section -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #666;">üìÖ Update Frequency:</h3>
                    <select id="editFileFrequency" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                        <option value="daily">üî¥ Daily - Updated every day</option>
                        <option value="weekly">üü† Weekly - Updated every week</option>
                        <option value="monthly" selected>üü° Monthly - Updated every month</option>
                        <option value="quarterly">üü¢ Quarterly - Updated every 3 months</option>
                        <option value="semi">üîµ Semi-Annually - Updated twice a year</option>
                        <option value="annually">üü£ Annually - Updated once a year</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                        üí° This helps users organize dashboards by how often they need to check them
                    </div>
                </div>

                <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #856404;">
                        <strong>‚ö†Ô∏è Note:</strong> Changes take effect immediately. Users will see updated access in their dashboard.
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="closeEditAccessModal()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
                    <button onclick="saveAccessChanges()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">üíæ Save Changes</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Upload File Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 style="margin: 0 0 8px 0;">üì§ Upload Data Files</h2>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">üìÅ Files will be saved to: PULSE-Prototype/uploads/</p>
                </div>
                <span class="close" onclick="closeUploadModal()">&times;</span>
            </div>
            <div class="modal-body">

                <!-- Upload Area -->
                <div id="uploadArea" class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" style="display: none;" multiple accept=".xlsx,.xls,.csv,.html,.pdf,.txt,.json">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                    <h3 style="color: #667eea; margin-bottom: 10px;">Click to browse or drag & drop files</h3>
                    <p style="color: #666; font-size: 14px;">Supported formats: Excel (.xlsx, .xls), CSV, HTML, PDF, TXT, JSON</p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px;">Maximum file size: 50 MB per file</p>
                </div>

                <!-- File Metadata Form (shown after file selection) -->
                <div id="fileMetadataForm" style="display: none; margin-top: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="margin: 0 0 20px 0; color: #333; font-size: 16px;">üìù File Details</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666; font-weight: 500;">File Name</label>
                        <input type="text" id="uploadFileName" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #fff;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666; font-weight: 500;">Description</label>
                        <textarea id="uploadDescription" rows="3" placeholder="What does this file contain?" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666; font-weight: 500;">Category</label>
                        <select id="uploadCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="sap_export">SAP Export Data</option>
                            <option value="financial">Financial Report</option>
                            <option value="dashboard_template">Dashboard Template</option>
                            <option value="analytics">Analytics Report</option>
                            <option value="raw_data">Raw Data</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div style="background: #e7f3ff; border: 1px solid #0066cc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: #004085;">
                            <strong>üí° Note:</strong> File will be saved to shared storage folder. Use <strong>Manage Access</strong> to assign this file to Business Users.
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="cancelUpload()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
                        <button onclick="saveUploadedFile()" style="flex: 1; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">üíæ Save to Folder</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in and is master
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        
        // Global variables for file management
        let currentEditFileId = null;
        let selectedFile = null;
        let selectedFileData = null;
        
        if (!currentUser) {
            window.location.href = 'index.html';
        } else if (currentUser.role !== 'master') {
            alert('Access denied! Master privileges required.');
            if (currentUser.role === 'principal_master') {
                window.location.href = 'admin.html';
            } else {
                window.location.href = 'dashboard.html';
            }
        } else {
            document.getElementById('userName').textContent = currentUser.user_id;
            document.getElementById('welcomeUser').textContent = currentUser.user_id;
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // File Upload Modal Functions
        let eventListenersAttached = false;

        function openUploadModal() {
            document.getElementById('uploadModal').style.display = 'block';
            
            // Attach event listeners on first open
            if (!eventListenersAttached) {
                attachUploadEventListeners();
                eventListenersAttached = true;
            }
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            resetUploadForm();
        }

        function toggleAllUsers() {
            const allCheckbox = document.getElementById('assignAll');
            const userCheckboxes = document.querySelectorAll('.userCheckbox');
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = allCheckbox.checked;
            });
        }

        function attachUploadEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            if (!fileInput || !uploadArea) return;

            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect({ target: { files: files } });
                }
            });
        }

        // Close modal on backdrop click
        window.onclick = function(event) {
            const modal = document.getElementById('uploadModal');
            if (event.target == modal) {
                closeUploadModal();
            }
        };

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (50 MB limit)
            const maxSize = 50 * 1024 * 1024; // 50 MB
            if (file.size > maxSize) {
                alert('[WARNING] File too large!\n\nMaximum file size is 50 MB.\nYour file: ' + formatFileSize(file.size));
                return;
            }

            selectedFile = file;

            // Read file as base64
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedFileData = e.target.result;
                
                // Show metadata form
                document.getElementById('fileMetadataForm').style.display = 'block';
                document.getElementById('uploadFileName').value = file.name;
                
                // Scroll to form
                document.getElementById('fileMetadataForm').scrollIntoView({ behavior: 'smooth' });
            };
            reader.readAsDataURL(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function getFileIcon(fileType) {
            const icons = {
                'xlsx': 'üìä',
                'xls': 'üìä',
                'csv': 'üìÑ',
                'html': 'üåê',
                'pdf': 'üìï',
                'txt': 'üìù',
                'json': 'üìã'
            };
            return icons[fileType] || 'üìÅ';
        }

        function saveUploadedFile() {
            if (!selectedFile || !selectedFileData) {
                alert('‚ö†Ô∏è No file selected!');
                return;
            }

            const description = document.getElementById('uploadDescription').value.trim();
            const category = document.getElementById('uploadCategory').value;
            
            // Create file object with empty assignedTo (will assign in Manage Access)
            const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
            const filePath = `PULSE-Prototype/uploads/${selectedFile.name}`;
            const fileObject = {
                id: Date.now().toString(),
                fileName: selectedFile.name,
                filePath: filePath,
                fileType: fileExtension,
                base64Data: selectedFileData,
                size: selectedFile.size,
                sizeFormatted: formatFileSize(selectedFile.size),
                uploadDate: Date.now(),
                uploadedBy: currentUser.user_id,
                assignedTo: [], // Empty by default - assign in Manage Access
                description: description || 'No description provided',
                category: category
            };

            // Get existing files from localStorage
            let uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            uploadedFiles.unshift(fileObject);

            // Save to localStorage
            try {
                localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                
                alert('[SUCCESS] File Saved Successfully!\n\n' +
                      'File: ' + selectedFile.name + '\n' +
                      'Size: ' + formatFileSize(selectedFile.size) + '\n' +
                      'Location: ' + filePath + '\n' +
                      'Category: ' + getCategoryLabel(category) + '\n\n' +
                      '>> Open "Manage Access" tile to view all files and assign to Business Users.');
                
                closeUploadModal();
                
            } catch (e) {
                alert('[ERROR] Upload Failed!\n\n' +
                      'Error: localStorage quota exceeded.\n' +
                      'Please delete some old files to free up space.\n\n' +
                      'Note: This is a prototype limitation. Production would use cloud storage.');
            }
        }

        function resetUploadForm() {
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadDescription').value = '';
            document.getElementById('uploadCategory').value = 'sap_export';
            document.getElementById('fileMetadataForm').style.display = 'none';
            selectedFile = null;
            selectedFileData = null;
        }

        function cancelUpload() {
            resetUploadForm();
        }

        function formatDateTime(timestamp, format) {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            let dateStr;
            if (format === 'MM/DD/YYYY') {
                dateStr = `${month}/${day}/${year}`;
            } else if (format === 'YYYY-MM-DD') {
                dateStr = `${year}-${month}-${day}`;
            } else {
                dateStr = `${day}/${month}/${year}`;
            }
            
            return `${dateStr} ${hours}:${minutes}`;
        }

        function getCategoryLabel(category) {
            const labels = {
                'sap_export': 'SAP Export',
                'financial': 'Financial',
                'dashboard_template': 'Dashboard',
                'analytics': 'Analytics',
                'raw_data': 'Raw Data',
                'other': 'Other'
            };
            return labels[category] || category;
        }

        function viewFile(fileId) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            const file = uploadedFiles.find(f => f.id === fileId);
            
            if (!file) return;

            // For physical files, open directly
            if (!file.base64Data || file.isPhysicalFile) {
                const filePath = file.filePath || `uploads/${file.fileName}`;
                window.open(filePath, '_blank');
                return;
            }

            // For base64 files (legacy)
            if (file.fileType === 'html') {
                // Open HTML in new window
                const newWindow = window.open('', '_blank');
                newWindow.document.write(atob(file.base64Data.split(',')[1]));
            } else if (file.fileType === 'txt' || file.fileType === 'csv') {
                // Show text content in alert
                const content = atob(file.base64Data.split(',')[1]);
                const preview = content.substring(0, 500) + (content.length > 500 ? '...' : '');
                alert(`File Preview: ${file.fileName}\n\n${preview}\n\n(Use Download button for full file)`);
            } else {
                alert('[VIEW] Preview not available for ' + file.fileType.toUpperCase() + ' files.\n\nUse the Download button to save the file.');
            }
        }

        function downloadFile(fileId) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            const file = uploadedFiles.find(f => f.id === fileId);
            
            if (!file) return;

            // Create download link
            const link = document.createElement('a');
            link.href = file.base64Data;
            link.download = file.fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('[SUCCESS] Download Started!\n\nFile: ' + file.fileName + '\nSize: ' + file.sizeFormatted);
        }

        function deleteFile(fileId) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            const file = uploadedFiles.find(f => f.id === fileId);
            
            if (!file) return;

            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            const assignmentData = fileAssignments[file.fileName];
            let assignedTo = [];
            
            if (Array.isArray(assignmentData)) {
                assignedTo = assignmentData;
            } else if (assignmentData && assignmentData.assignedTo) {
                assignedTo = assignmentData.assignedTo;
            }
            
            const assignedDisplay = assignedTo.length > 0 ? assignedTo.join(', ') : 'Unassigned';
            
            if (confirm('[WARNING] Delete File?\n\nFile: ' + file.fileName + '\nSize: ' + (file.sizeFormatted || formatFileSize(file.size)) + '\nAssigned to: ' + assignedDisplay + '\n\nThis will remove the file from the system and unassign it from all users.\n\nThis action cannot be undone.')) {
                // Remove from uploadedFiles
                const updatedFiles = uploadedFiles.filter(f => f.id !== fileId);
                localStorage.setItem('uploadedFiles', JSON.stringify(updatedFiles));
                
                // Remove from fileAssignments
                delete fileAssignments[file.fileName];
                localStorage.setItem('fileAssignments', JSON.stringify(fileAssignments));
                
                // Remove from assignedFiles
                const assignedFiles = JSON.parse(localStorage.getItem('assignedFiles')) || {};
                delete assignedFiles[file.fileName];
                localStorage.setItem('assignedFiles', JSON.stringify(assignedFiles));
                
                loadAccessFiles(); // Refresh the access modal
                alert('[SUCCESS] File Deleted!\n\n' + file.fileName + ' has been removed from the system.\n\nNote: The physical file in uploads/ folder still exists on your computer.');
            }
        }

        function deleteFileFromList(fileName) {
            // Find file by name in uploadedFiles
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            const file = uploadedFiles.find(f => f.fileName === fileName);
            
            if (!file) {
                alert('[WARNING] File not found!');
                return;
            }
            
            // Call deleteFile with the fileId
            deleteFile(file.id);
        }

        // Manage Access Modal Functions

        function openManageAccessModal() {
            document.getElementById('manageAccessModal').style.display = 'block';
            showFolderView();
        }
        
        // Helper function to convert base64 data URL to Blob
        function dataURLtoBlob(dataURL) {
            const parts = dataURL.split(',');
            const mime = parts[0].match(/:(.*?);/)[1];
            const bstr = atob(parts[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }
        
        function getMimeType(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const mimeTypes = {
                'html': 'text/html',
                'pdf': 'application/pdf',
                'txt': 'text/plain',
                'csv': 'text/csv',
                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'xls': 'application/vnd.ms-excel',
                'json': 'application/json'
            };
            return mimeTypes[ext] || 'application/octet-stream';
        }

        function closeManageAccessModal() {
            document.getElementById('manageAccessModal').style.display = 'none';
        }

        function showFolderView() {
            document.getElementById('folderView').style.display = 'block';
            document.getElementById('fileView').style.display = 'none';
            document.getElementById('fileToolbar').style.display = 'none';
            document.getElementById('storageBar_container').style.display = 'none';
            document.getElementById('backButton').style.display = 'none';
            document.getElementById('breadcrumbUploads').style.display = 'none';
            
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            document.getElementById('folderItemCount').textContent = `${uploadedFiles.length} item${uploadedFiles.length !== 1 ? 's' : ''}`;
        }

        function showFileView() {
            console.log('=== showFileView called ===');
            document.getElementById('folderView').style.display = 'none';
            document.getElementById('fileView').style.display = 'block';
            document.getElementById('fileToolbar').style.display = 'flex';
            document.getElementById('storageBar_container').style.display = 'flex';
            document.getElementById('backButton').style.display = 'inline-block';
            document.getElementById('breadcrumbUploads').style.display = 'inline';
            
            // Check if we have uploaded files - show them first
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            console.log('Checking uploadedFiles:', uploadedFiles);
            console.log('Number of files:', uploadedFiles.length);
            
            if (uploadedFiles.length > 0) {
                console.log('Files exist - calling loadAccessFiles()');
                loadAccessFiles();
            } else {
                console.log('No files - calling showFileBrowser()');
                // No files yet - show browse button
                showFileBrowser();
            }
        }
        
        function showFileBrowser() {
            const container = document.getElementById('accessTableBody');
            const emptyState = document.getElementById('accessEmptyState');
            const folderCount = document.getElementById('folderFileCount');
            
            container.style.display = 'none';
            emptyState.style.display = 'block';
            folderCount.textContent = '0 items';
            
            emptyState.innerHTML = `
                <svg width="80" height="80" viewBox="0 0 24 24" fill="#667eea" style="margin-bottom: 20px;">
                    <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                </svg>
                <h3 style="color: #333; margin-bottom: 10px; font-size: 18px;">üìÅ No Files Yet</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Click the "‚ûï Add Files" button above to browse and select files from your computer</p>
                <p style="color: #999; font-size: 12px;">Navigate to: PULSE - Proto Type/uploads folder when browsing</p>
            `;
        }
        
        function handleFolderSelect(files) {
            console.log('handleFolderSelect called with', files.length, 'files');
            if (!files || files.length === 0) {
                return;
            }
            
            // Show loading message
            const container = document.getElementById('accessTableBody');
            const emptyState = document.getElementById('accessEmptyState');
            container.style.display = 'block';
            emptyState.style.display = 'none';
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: #667eea;"><div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>Processing ' + files.length + ' files...</div>';
            
            const fileArray = Array.from(files);
            let uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            console.log('Current uploadedFiles:', uploadedFiles.length);
            
            let processedCount = 0;
            const totalFiles = fileArray.length;
            
            fileArray.forEach((file, index) => {
                console.log('Processing file:', file.name);
                
                // Check if file already exists
                const existingIndex = uploadedFiles.findIndex(f => f.fileName === file.name);
                if (existingIndex >= 0) {
                    console.log('File already exists:', file.name);
                    processedCount++;
                    if (processedCount === totalFiles) {
                        console.log('All files processed, loading display');
                        loadAccessFiles();
                    }
                    return;
                }
                
                // Read file and save to localStorage
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('FileReader completed for:', file.name);
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    const fileObject = {
                        id: Date.now().toString() + '_' + index,
                        fileName: file.name,
                        filePath: `uploads/${file.name}`,
                        fileType: fileExtension,
                        base64Data: e.target.result,
                        size: file.size,
                        sizeFormatted: formatFileSize(file.size),
                        uploadDate: Date.now(),
                        uploadedBy: currentUser.user_id,
                        assignedTo: [],
                        description: 'Added via Manage Access',
                        category: 'other'
                    };
                    
                    // Re-read uploadedFiles to get latest version
                    uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
                    uploadedFiles.push(fileObject);
                    localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                    console.log('Saved file to localStorage:', file.name);
                    console.log('Total files in storage now:', uploadedFiles.length);
                    
                    processedCount++;
                    console.log('Processed', processedCount, 'of', totalFiles);
                    
                    // Refresh display after all files are processed
                    if (processedCount === totalFiles) {
                        console.log('All files processed, loading display');
                        alert('File saved! Now loading display...');
                        setTimeout(() => {
                            loadAccessFiles();
                        }, 200);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('FileReader error for', file.name, ':', error);
                    alert('Error reading file: ' + file.name);
                    processedCount++;
                    if (processedCount === totalFiles) {
                        loadAccessFiles();
                    }
                };
                
                console.log('Starting FileReader for:', file.name);
                reader.readAsDataURL(file);
            });
        }
        
        function openFileAssignModal(fileName, file) {
            window.currentAssignFile = file;
            window.currentAssignFileName = fileName;
            
            document.getElementById('editAccessFileName').textContent = fileName;
            document.getElementById('editAccessFilePath').innerHTML = `üìÅ uploads/${fileName}`;
            
            // Load current assignments
            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            const assignmentData = fileAssignments[fileName];
            let assignedTo = [];
            let frequency = 'monthly';
            
            if (Array.isArray(assignmentData)) {
                assignedTo = assignmentData;
            } else if (assignmentData && assignmentData.assignedTo) {
                assignedTo = assignmentData.assignedTo;
                frequency = assignmentData.frequency || 'monthly';
            }
            
            // Set checkboxes
            const allCheckbox = document.getElementById('editAssignAll');
            const userCheckboxes = document.querySelectorAll('.editUserCheckbox');
            
            allCheckbox.checked = assignedTo.includes('all') || 
                                 (assignedTo.includes('SCD_CIS') && assignedTo.includes('SCD_PUR') && 
                                  assignedTo.includes('SCD_WHS') && assignedTo.includes('SCD_SRM') && 
                                  assignedTo.includes('SCD_MGR'));
            
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = assignedTo.includes(checkbox.value);
            });
            
            document.getElementById('editFileFrequency').value = frequency;
            document.getElementById('editAccessModal').style.display = 'block';
        }

        // File management helper functions removed - using simplified workflow

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function openEditAccessModal(fileId) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            const file = uploadedFiles.find(f => f.id === fileId);
            
            if (!file) return;

            currentEditFileId = fileId;
            
            // Set file name and path in modal
            document.getElementById('editAccessFileName').textContent = file.fileName;
            const filePath = file.filePath || `PULSE-Prototype/uploads/${file.fileName}`;
            document.getElementById('editAccessFilePath').innerHTML = `üìÅ ${filePath}`;
            
            // Set current assignments
            const allCheckbox = document.getElementById('editAssignAll');
            const userCheckboxes = document.querySelectorAll('.editUserCheckbox');
            
            // Get assignment data - handle both old array format and new object format
            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            const assignmentData = fileAssignments[file.fileName];
            let assignedTo = [];
            let frequency = 'monthly';
            
            if (Array.isArray(assignmentData)) {
                // Old format: just an array of user IDs
                assignedTo = assignmentData;
            } else if (assignmentData && assignmentData.assignedTo) {
                // New format: object with assignedTo array and frequency
                assignedTo = assignmentData.assignedTo;
                frequency = assignmentData.frequency || 'monthly';
            }
            
            // Check if all users are assigned
            allCheckbox.checked = assignedTo.includes('all') || 
                                 (assignedTo.includes('SCD_CIS') && assignedTo.includes('SCD_PUR') && 
                                  assignedTo.includes('SCD_WHS') && assignedTo.includes('SCD_SRM') && 
                                  assignedTo.includes('SCD_MGR'));
            
            // Set individual checkboxes
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = assignedTo.includes(checkbox.value);
            });
            
            // Set frequency dropdown
            document.getElementById('editFileFrequency').value = frequency;
            
            document.getElementById('editAccessModal').style.display = 'block';
        }

        function viewRealFile(fileName) {
            window.open(`uploads/${fileName}`, '_blank');
        }

        function downloadRealFile(fileName) {
            const link = document.createElement('a');
            link.href = `uploads/${fileName}`;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert(`‚úÖ Download Started!\\n\\nFile: ${fileName}`);
        }

        // Duplicate functions removed - using simplified workflow from loadAccessFiles

        function loadAccessFiles() {
            console.log('=== loadAccessFiles called ===');
            let uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            
            // Debug: Check what's in localStorage
            console.log('Files in localStorage:', uploadedFiles);
            console.log('Total files:', uploadedFiles.length);
            
            const container = document.getElementById('accessTableBody');
            const emptyState = document.getElementById('accessEmptyState');
            const folderCount = document.getElementById('folderFileCount');
            
            console.log('container element:', container);
            console.log('emptyState element:', emptyState);
            console.log('folderCount element:', folderCount);
            
            container.innerHTML = '';

            // Data migration: add missing filePath property to old files
            let needsSave = false;
            uploadedFiles = uploadedFiles.map(file => {
                if (!file.filePath) {
                    file.filePath = `PULSE-Prototype/uploads/${file.fileName}`;
                    needsSave = true;
                }
                if (file.assignedTo === undefined) {
                    file.assignedTo = [];
                    needsSave = true;
                }
                return file;
            });
            if (needsSave) {
                localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                console.log('Updated files with missing properties');
            }

            // Update folder file count and storage info
            console.log('Setting folder count to:', uploadedFiles.length);
            folderCount.textContent = `${uploadedFiles.length} item${uploadedFiles.length !== 1 ? 's' : ''}`;
            updateStorageDisplay(uploadedFiles);

            if (uploadedFiles.length === 0) {
                console.log('No files found, showing empty state');
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            console.log('Files found, showing container');
            container.style.display = 'block';
            emptyState.style.display = 'none';

            uploadedFiles.forEach((file, index) => {
                try {
                    console.log('Rendering file:', file.fileName);
                    const fileName = file.fileName;
                    const settings = JSON.parse(localStorage.getItem('systemSettings')) || { dateFormat: 'DD/MM/YYYY' };
                    const uploadDate = formatDateTime(file.uploadDate, settings.dateFormat);
                    const fileIcon = getFileIconWithColor(file.fileType);
                    const fileId = file.id;
                
                // Get assignment info from fileAssignments
                const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
                const assignmentData = fileAssignments[fileName];
                let assignedTo = [];
                
                if (Array.isArray(assignmentData)) {
                    assignedTo = assignmentData;
                } else if (assignmentData && assignmentData.assignedTo) {
                    assignedTo = assignmentData.assignedTo;
                } else if (file.assignedTo) {
                    assignedTo = file.assignedTo;
                }
                
                let assignedDisplay;
                if (!assignedTo || assignedTo.length === 0) {
                    assignedDisplay = '<span style="background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">‚ö†Ô∏è None</span>';
                } else if (assignedTo.includes('all') || (assignedTo.includes('SCD_CIS') && assignedTo.includes('SCD_PUR') && assignedTo.includes('SCD_WHS') && assignedTo.includes('SCD_SRM') && assignedTo.includes('SCD_MGR'))) {
                    assignedDisplay = '<span style="background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">üë• All</span>';
                } else {
                    assignedDisplay = assignedTo.map(user => `<span style="background: #e7f3ff; color: #0066cc; padding: 3px 8px; border-radius: 10px; font-size: 11px; margin-right: 4px;">${user}</span>`).join('');
                }
                
                const fileRow = document.createElement('div');
                fileRow.style.cssText = `
                    display: grid; 
                    grid-template-columns: 45% 15% 10% 15% 15%; 
                    padding: 12px 15px; 
                    border-radius: 6px; 
                    margin-bottom: 4px;
                    align-items: center;
                    cursor: pointer;
                    transition: background 0.2s;
                    font-size: 13px;
                `;
                
                fileRow.onmouseover = function() { this.style.background = '#f8f9fa'; };
                fileRow.onmouseout = function() { this.style.background = 'transparent'; };
                fileRow.onclick = function(e) { 
                    if (!e.target.closest('button')) {
                        openEditAccessModal(fileId); 
                    }
                };
                
                fileRow.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${fileIcon}
                        <div style="overflow: hidden;">
                            <div style="font-weight: 500; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.fileName}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">${file.description}</div>
                        </div>
                    </div>
                    <div style="color: #666;">${getCategoryLabel(file.category)}</div>
                    <div style="color: #666;">${file.sizeFormatted}</div>
                    <div>${assignedDisplay}</div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="color: #666; font-size: 12px;">${uploadDate.split(' ')[0]}</span>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="event.stopPropagation(); viewFile('${fileId}')" title="View" style="padding: 5px 8px; background: #e7f3ff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üëÅÔ∏è</button>
                            <button onclick="event.stopPropagation(); downloadFile('${fileId}')" title="Download" style="padding: 5px 8px; background: #d4edda; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">‚¨áÔ∏è</button>
                            <button onclick="event.stopPropagation(); deleteFileFromList('${fileName}')" title="Delete" style="padding: 5px 8px; background: #f8d7da; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(fileRow);
                console.log('File row added to container:', file.fileName);
                
                } catch (error) {
                    console.error('Error rendering file:', file.fileName, error);
                }
            });
            
            console.log('All files rendered. Container children:', container.children.length);
        }

        function getFileIconWithColor(fileType) {
            const icons = {
                'xlsx': '<svg width="32" height="32" viewBox="0 0 48 48"><rect width="48" height="48" fill="#21A366" rx="4"/><text x="24" y="32" fill="white" font-size="16" font-weight="bold" text-anchor="middle" font-family="Arial">XLS</text></svg>',
                'xls': '<svg width="32" height="32" viewBox="0 0 48 48"><rect width="48" height="48" fill="#21A366" rx="4"/><text x="24" y="32" fill="white" font-size="16" font-weight="bold" text-anchor="middle" font-family="Arial">XLS</text></svg>',
                'csv': '<svg width="32" height="32" viewBox="0 0 48 48"><rect width="48" height="48" fill="#0078D4" rx="4"/><text x="24" y="32" fill="white" font-size="16" font-weight="bold" text-anchor="middle" font-family="Arial">CSV</text></svg>',
                'html': '<svg width="32" height="32" viewBox="0 0 48 48"><rect width="48" height="48" fill="#E34F26" rx="4"/><text x="24" y="32" fill="white" font-size="14" font-weight="bold" text-anchor="middle" font-family="Arial">HTML</text></svg>',
                'pdf': '<svg width="32" height="32" viewBox="0 0 48 48"><rect width="48" height="48" fill="#F40F02" rx="4"/><text x="24" y="32" fill="white" font-size="16" font-weight="bold" text-anchor="middle" font-family="Arial">PDF</text></svg>',
                'txt': '<svg width="32" height="32" viewBox="0 0 48 48"><rect width="48" height="48" fill="#6C757D" rx="4"/><text x="24" y="32" fill="white" font-size="16" font-weight="bold" text-anchor="middle" font-family="Arial">TXT</text></svg>',
                'json': '<svg width="32" height="32" viewBox="0 0 48 48"><rect width="48" height="48" fill="#FFC107" rx="4"/><text x="24" y="32" fill="white" font-size="14" font-weight="bold" text-anchor="middle" font-family="Arial">JSON</text></svg>'
            };
            return icons[fileType] || '<svg width="32" height="32" viewBox="0 0 48 48"><rect width="48" height="48" fill="#95A5A6" rx="4"/><text x="24" y="32" fill="white" font-size="16" font-weight="bold" text-anchor="middle" font-family="Arial">FILE</text></svg>';
        }

        function updateStorageDisplay(files) {
            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const totalMB = (totalSize / (1024 * 1024)).toFixed(2);
            const maxStorage = 100; // 100 MB max for demo
            const percentage = Math.min((totalMB / maxStorage) * 100, 100).toFixed(1);
            
            document.getElementById('storageUsed').textContent = `${totalMB} MB`;
            document.getElementById('storageBar').style.width = `${percentage}%`;
            document.getElementById('storagePercent').textContent = `${percentage}%`;
        }

        function exportAllFiles() {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            
            if (uploadedFiles.length === 0) {
                alert('üì¶ No files to export!\n\nUpload some files first.');
                return;
            }
            
            alert(`üì¶ Export Feature\n\n${uploadedFiles.length} file${uploadedFiles.length !== 1 ? 's' : ''} ready to export.\n\nIn production, this would create a ZIP file with all files and their assignments.\n\nFor demo: Files are safely stored in browser memory.`);
        }

        function filterAccessFiles() {
            const searchValue = document.getElementById('accessSearchInput').value.toLowerCase();
            const filterValue = document.getElementById('accessFilterSelect').value;
            
            console.log('=== Filter Called ===');
            console.log('Search:', searchValue);
            console.log('Filter:', filterValue);
            
            // If no files loaded yet, do nothing
            if (!window.currentFolderFiles || window.currentFolderFiles.length === 0) {
                console.log('No files loaded yet');
                return;
            }
            
            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            console.log('File assignments:', fileAssignments);
            let filteredFiles = Array.from(window.currentFolderFiles);
            console.log('Total files before filter:', filteredFiles.length);

            // Filter by search (search in filename only since we don't have descriptions for real files)
            if (searchValue) {
                filteredFiles = filteredFiles.filter(file => 
                    file.name.toLowerCase().includes(searchValue)
                );
            }

            // Filter by user
            if (filterValue !== 'all') {
                console.log('Applying filter:', filterValue);
                if (filterValue === 'unassigned') {
                    filteredFiles = filteredFiles.filter(file => {
                        const assigned = fileAssignments[file.name] || [];
                        const match = assigned.length === 0;
                        console.log(`${file.name}: assigned=${JSON.stringify(assigned)}, unassigned=${match}`);
                        return match;
                    });
                } else if (filterValue === 'all_users') {
                    filteredFiles = filteredFiles.filter(file => {
                        const assigned = fileAssignments[file.name] || [];
                        const match = assigned.includes('all') || (assigned.includes('SCD_CIS') && assigned.includes('SCD_PUR') && assigned.includes('SCD_WHS') && assigned.includes('SCD_SRM') && assigned.includes('SCD_MGR'));
                        console.log(`${file.name}: assigned=${JSON.stringify(assigned)}, all_users=${match}`);
                        return match;
                    });
                } else {
                    filteredFiles = filteredFiles.filter(file => {
                        const assigned = fileAssignments[file.name] || [];
                        const match = assigned.includes(filterValue);
                        console.log(`${file.name}: assigned=${JSON.stringify(assigned)}, includes ${filterValue}=${match}`);
                        return match;
                    });
                }
            }
            console.log('Files after filter:', filteredFiles.length);

            // Render filtered files
            const container = document.getElementById('accessTableBody');
            const emptyState = document.getElementById('accessEmptyState');
            const folderCount = document.getElementById('folderFileCount');
            container.innerHTML = '';

            folderCount.textContent = `${filteredFiles.length} item${filteredFiles.length !== 1 ? 's' : ''}`;

            if (filteredFiles.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="#ddd" style="margin-bottom: 20px;">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <h3 style="color: #999; margin-bottom: 10px; font-size: 18px;">No files match your search</h3>
                    <p style="color: #bbb; font-size: 14px;">Try different keywords or filter</p>
                `;
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            filteredFiles.forEach(file => {
                const fileName = file.name;
                const fileSize = file.size;
                const fileSizeFormatted = formatFileSize(fileSize);
                const fileType = fileName.split('.').pop().toLowerCase();
                const fileIcon = getFileIconWithColor(fileType);
                
                // Get assignment info
                const assignedTo = fileAssignments[fileName] || [];
                let assignedDisplay;
                if (assignedTo.length === 0) {
                    assignedDisplay = '<span style="background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">‚ö†Ô∏è None</span>';
                } else if (assignedTo.includes('all') || (assignedTo.includes('SCD_CIS') && assignedTo.includes('SCD_PUR') && assignedTo.includes('SCD_WHS') && assignedTo.includes('SCD_SRM') && assignedTo.includes('SCD_MGR'))) {
                    assignedDisplay = '<span style="background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">üë• All</span>';
                } else {
                    assignedDisplay = assignedTo.map(user => `<span style="background: #e7f3ff; color: #0066cc; padding: 3px 8px; border-radius: 10px; font-size: 11px; margin-right: 4px;">${user}</span>`).join('');
                }
                
                const fileRow = document.createElement('div');
                fileRow.style.cssText = `
                    display: grid; 
                    grid-template-columns: 45% 15% 10% 15% 15%; 
                    padding: 12px 15px; 
                    border-radius: 6px; 
                    margin-bottom: 4px;
                    align-items: center;
                    cursor: pointer;
                    transition: background 0.2s;
                    font-size: 13px;
                `;
                
                fileRow.onmouseover = function() { this.style.background = '#f8f9fa'; };
                fileRow.onmouseout = function() { this.style.background = 'transparent'; };
                fileRow.onclick = function(e) { 
                    if (!e.target.closest('button')) {
                        openRealFileAccessModal(fileName, file); 
                    }
                };
                
                const lastModified = new Date(file.lastModified);
                const modifiedDate = `${String(lastModified.getDate()).padStart(2,'0')}/${String(lastModified.getMonth()+1).padStart(2,'0')}/${lastModified.getFullYear()}`;
                
                fileRow.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${fileIcon}
                        <div style="overflow: hidden;">
                            <div style="font-weight: 500; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${fileName}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">üìÅ uploads/${fileName}</div>
                        </div>
                    </div>
                    <div style="color: #666;">${fileType.toUpperCase()}</div>
                    <div style="color: #666;">${fileSizeFormatted}</div>
                    <div>${assignedDisplay}</div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="color: #666; font-size: 12px;">${modifiedDate}</span>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="event.stopPropagation(); viewRealFile('${fileName}')" title="View" style="padding: 5px 8px; background: #e7f3ff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üëÅÔ∏è</button>
                            <button onclick="event.stopPropagation(); downloadFile('${fileId}')" title="Download" style="padding: 5px 8px; background: #d4edda; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">‚¨áÔ∏è</button>
                            <button onclick="event.stopPropagation(); deleteFileFromList('${fileName}')" title="Remove" style="padding: 5px 8px; background: #f8d7da; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                            <button onclick="event.stopPropagation(); deleteFile('${fileId}')" title="Delete" style="padding: 5px 8px; background: #f8d7da; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(fileRow);
            });
        }

        function openEditAccessModal(fileId) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            const file = uploadedFiles.find(f => f.id === fileId);
            
            if (!file) return;

            currentEditFileId = fileId;
            
            // Set file name and path in modal
            document.getElementById('editAccessFileName').textContent = file.fileName;
            const filePath = file.filePath || `PULSE-Prototype/uploads/${file.fileName}`;
            document.getElementById('editAccessFilePath').innerHTML = `üìÅ ${filePath}`;
            
            // Set current assignments
            const allCheckbox = document.getElementById('editAssignAll');
            const userCheckboxes = document.querySelectorAll('.editUserCheckbox');
            
            // Check if all users are assigned
            allCheckbox.checked = file.assignedTo && file.assignedTo.length === 2;
            
            // Set individual checkboxes
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = file.assignedTo && file.assignedTo.includes(checkbox.value);
            });
            
            document.getElementById('editAccessModal').style.display = 'block';
        }

        function closeEditAccessModal() {
            document.getElementById('editAccessModal').style.display = 'none';
            currentEditFileId = null;
            window.currentEditFile = null;
        }

        function toggleAllUsersEdit() {
            const allCheckbox = document.getElementById('editAssignAll');
            const userCheckboxes = document.querySelectorAll('.editUserCheckbox');
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = allCheckbox.checked;
            });
        }

        function saveAccessChanges() {
            // Handle both uploaded files and browsed files
            let fileName, fileId;
            
            if (currentEditFileId) {
                // From uploaded files
                const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
                const fileIndex = uploadedFiles.findIndex(f => f.id === currentEditFileId);
                
                if (fileIndex === -1) {
                    alert('‚ùå Error: File not found');
                    return;
                }
                
                fileName = uploadedFiles[fileIndex].fileName;
                fileId = currentEditFileId;
            } else if (window.currentAssignFileName) {
                // From browsed files - find in uploadedFiles
                fileName = window.currentAssignFileName;
                const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
                const file = uploadedFiles.find(f => f.fileName === fileName);
                if (file) {
                    fileId = file.id;
                }
            } else {
                alert('‚ùå Error: No file selected');
                return;
            }

            // Get selected users
            const selectedUsers = [];
            document.querySelectorAll('.editUserCheckbox:checked').forEach(checkbox => {
                selectedUsers.push(checkbox.value);
            });
            
            // Get selected frequency
            const frequency = document.getElementById('editFileFrequency').value;

            // Update uploadedFiles with assignments
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
            const fileIndex = uploadedFiles.findIndex(f => f.fileName === fileName);
            if (fileIndex !== -1) {
                uploadedFiles[fileIndex].assignedTo = selectedUsers;
                localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
            }

            // Save to fileAssignments with frequency
            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            fileAssignments[fileName] = {
                assignedTo: selectedUsers,
                frequency: frequency
            };
            localStorage.setItem('fileAssignments', JSON.stringify(fileAssignments));
            
            // Save to assignedFiles for business users (store minimal data for physical files)
            if (fileIndex !== -1) {
                const assignedFiles = JSON.parse(localStorage.getItem('assignedFiles')) || {};
                // For physical files, only store path and metadata (not base64 to save space)
                assignedFiles[fileName] = {
                    fileName: uploadedFiles[fileIndex].fileName,
                    filePath: uploadedFiles[fileIndex].filePath || `uploads/${fileName}`,
                    fileType: uploadedFiles[fileIndex].fileType,
                    size: uploadedFiles[fileIndex].size,
                    isPhysicalFile: true // Flag to indicate this is a real file
                };
                localStorage.setItem('assignedFiles', JSON.stringify(assignedFiles));
            }
            
            if (selectedUsers.length === 0) {
                alert('[SUCCESS] Access Updated!\n\n' + fileName + '\nStatus: Unassigned\nFrequency: ' + frequency);
            } else {
                alert('[SUCCESS] File Assigned!\n\nFile: ' + fileName + '\nAssigned to: ' + selectedUsers.join(', ') + '\nFrequency: ' + frequency + '\n\nBusiness users can now see this file in their dashboard.');
            }
            
            closeEditAccessModal();
            window.currentAssignFileName = null;
            window.currentAssignFile = null;
            loadAccessFiles();
        }

        // Close modals on backdrop click
        window.onclick = function(event) {
            const uploadModal = document.getElementById('uploadModal');
            const accessModal = document.getElementById('manageAccessModal');
            const editModal = document.getElementById('editAccessModal');
            
            if (event.target == uploadModal) {
                closeUploadModal();
            } else if (event.target == accessModal) {
                closeManageAccessModal();
            } else if (event.target == editModal) {
                closeEditAccessModal();
            }
        };
    </script>
</body>
</html>
