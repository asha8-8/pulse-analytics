<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PULSE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .welcome-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .welcome-card h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }

        .stat-card .description {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        .stat-card.blue {
            border-left: 4px solid #667eea;
        }

        .stat-card.blue .number {
            color: #667eea;
        }

        .stat-card.green {
            border-left: 4px solid #28a745;
        }

        .stat-card.green .number {
            color: #28a745;
        }

        .stat-card.orange {
            border-left: 4px solid #ff9800;
        }

        .stat-card.orange .number {
            color: #ff9800;
        }

        .stat-card.purple {
            border-left: 4px solid #9c27b0;
        }

        .stat-card.purple .number {
            color: #9c27b0;
        }

        .files-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .files-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e9ecef;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover::before {
            transform: scaleX(1);
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .dashboard-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
        }

        .dashboard-card.html .dashboard-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .dashboard-card.excel .dashboard-icon {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .dashboard-card.pdf .dashboard-icon {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .dashboard-card.csv .dashboard-icon {
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
        }

        .dashboard-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .dashboard-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .file-type-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-html {
            background: #e7f3ff;
            color: #0066cc;
        }

        .badge-excel {
            background: #d4edda;
            color: #155724;
        }

        .badge-pdf {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-csv {
            background: #fff3cd;
            color: #856404;
        }

        .dashboard-size {
            font-size: 12px;
            color: #999;
        }

        .dashboard-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .card-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .card-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .card-btn.primary:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .card-btn.secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #dee2e6;
        }

        .card-btn.secondary:hover {
            background: #e9ecef;
        }

        /* Frequency Tabs */
        .frequency-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            flex-wrap: wrap;
            align-items: center;
        }

        .frequency-tab {
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }

        .frequency-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .frequency-tab.active {
            border-color: transparent;
            color: white;
            transform: translateY(-2px);
        }

        .frequency-tab .badge {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
        }

        .frequency-tab.daily {
            border-color: #dc3545;
        }

        .frequency-tab.daily.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .frequency-tab.weekly {
            border-color: #ff9800;
        }

        .frequency-tab.weekly.active {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .frequency-tab.monthly {
            border-color: #ffc107;
        }

        .frequency-tab.monthly.active {
            background: linear-gradient(135deg, #ffc107 0%, #ffa000 100%);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .frequency-tab.quarterly {
            border-color: #28a745;
        }

        .frequency-tab.quarterly.active {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .frequency-tab.semi {
            border-color: #17a2b8;
        }

        .frequency-tab.semi.active {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .frequency-tab.annually {
            border-color: #6f42c1;
        }

        .frequency-tab.annually.active {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }

        .frequency-tab.all {
            border-color: #667eea;
        }

        .frequency-tab.all.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .file-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .file-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: #f8f9fa;
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .file-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-meta {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-download {
            background: #28a745;
            color: white;
        }

        .btn-view:hover {
            background: #138496;
        }

        .btn-download:hover {
            background: #218838;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div style="display: flex; align-items: center; gap: 12px;">
            <svg width="35" height="35" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="navLogoGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.9" />
                        <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="42" fill="none" stroke="white" stroke-width="1.5" opacity="0.3"/>
                <path d="M 12,50 Q 18,35 24,50 T 36,50 Q 42,65 48,50" fill="none" stroke="white" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
                <path d="M 30,50 Q 36,26 42,50 T 54,50 Q 60,20 66,50 T 78,50" fill="none" stroke="url(#navLogoGradient)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M 52,50 Q 58,65 64,50 T 76,50 Q 82,35 88,50" fill="none" stroke="#f093fb" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
                <circle cx="50" cy="50" r="7" fill="white"/>
                <circle cx="50" cy="50" r="4" fill="#764ba2"/>
                <circle cx="50" cy="15" r="3.5" fill="white" opacity="0.9"/>
                <circle cx="85" cy="50" r="3.5" fill="white" opacity="0.9"/>
                <circle cx="50" cy="85" r="3.5" fill="#f093fb" opacity="0.9"/>
                <circle cx="15" cy="50" r="3.5" fill="white" opacity="0.9"/>
            </svg>
            <h1>PULSE Dashboard</h1>
        </div>
        <div class="user-info">
            <span id="userName">Business User</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="welcome-card">
            <h2>Welcome, <span id="welcomeUser"></span>!</h2>
            <p>You are logged in as a Business User.</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card blue">
                <h3>üìä Assigned Dashboards</h3>
                <div class="number" id="totalAssignedFiles">0</div>
                <div class="description">Files assigned to you</div>
            </div>
            <div class="stat-card green">
                <h3>üìà Last Viewed</h3>
                <div class="number" style="font-size: 18px;" id="lastViewedFile">None</div>
                <div class="description">Most recent access</div>
            </div>
            <div class="stat-card orange">
                <h3>üîî New Assignments</h3>
                <div class="number" id="newAssignments">0</div>
                <div class="description">Added this week</div>
            </div>
            <div class="stat-card purple">
                <h3>üë§ Your Department</h3>
                <div class="number" style="font-size: 20px;" id="userDepartment">-</div>
                <div class="description">Business User Access</div>
            </div>
        </div>

        <!-- My Assigned Dashboard Section -->
        <div class="files-section">
            <h2>üì• My Assigned Dashboard</h2>
            
            <!-- Folder View -->
            <div id="businessFolderView">
                <div style="text-align: center; padding: 40px 20px;">
                    <div onclick="showBusinessFileView()" style="display: inline-flex; flex-direction: column; align-items: center; gap: 10px; padding: 30px 40px; background: white; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.08);" onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 4px 16px rgba(102,126,234,0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="#FFC107">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                        </svg>
                        <div style="font-size: 15px; font-weight: 600; color: #333;">üìÅ uploads</div>
                        <div style="font-size: 12px; color: #999;" id="businessFolderCount">0 files assigned</div>
                    </div>
                    <div style="margin-top: 15px; font-size: 13px; color: #999;">Click folder to view your assigned files</div>
                </div>
            </div>
            
            <!-- File List View -->
            <div id="businessFileView" style="display: none;">
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <button onclick="showBusinessFolderView()" style="padding: 8px 16px; background: white; border: 1px solid #ced4da; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: #666;">‚Üê Back to Folders</button>
                    <div style="font-size: 13px; color: #999;">
                        <span style="color: #666;">This PC</span> ‚Ä∫ <span style="color: #666;">PULSE-Prototype</span> ‚Ä∫ <span style="color: #667eea; font-weight: 600;">uploads</span>
                    </div>
                </div>
                
                <!-- Frequency Tabs -->
                <div class="frequency-tabs" id="frequencyTabs" style="display: none;">
                    <div class="frequency-tab all active" onclick="filterByFrequency('all')">
                        üìä All <span class="badge" id="countAll">0</span>
                    </div>
                    <div class="frequency-tab daily" onclick="filterByFrequency('daily')">
                        üî¥ Daily <span class="badge" id="countDaily">0</span>
                    </div>
                    <div class="frequency-tab weekly" onclick="filterByFrequency('weekly')">
                        üü† Weekly <span class="badge" id="countWeekly">0</span>
                    </div>
                    <div class="frequency-tab monthly" onclick="filterByFrequency('monthly')">
                        üü° Monthly <span class="badge" id="countMonthly">0</span>
                    </div>
                    <div class="frequency-tab quarterly" onclick="filterByFrequency('quarterly')">
                        üü¢ Quarterly <span class="badge" id="countQuarterly">0</span>
                    </div>
                    <div class="frequency-tab semi" onclick="filterByFrequency('semi')">
                        üîµ Semi-Annually <span class="badge" id="countSemi">0</span>
                    </div>
                    <div class="frequency-tab annually" onclick="filterByFrequency('annually')">
                        üü£ Annually <span class="badge" id="countAnnually">0</span>
                    </div>
                </div>
                
                <div id="filesList"></div>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        
        if (!currentUser) {
            window.location.href = 'index.html';
        } else {
            document.getElementById('userName').textContent = currentUser.user_id;
            document.getElementById('welcomeUser').textContent = currentUser.user_id;
            
            // Check localStorage status on load
            console.log('=== Dashboard Loading ===');
            console.log('localStorage available:', typeof(Storage) !== 'undefined');
            
            const assignedFilesData = localStorage.getItem('assignedFiles');
            const fileAssignmentsData = localStorage.getItem('fileAssignments');
            
            console.log('assignedFiles key exists:', !!assignedFilesData);
            console.log('fileAssignments key exists:', !!fileAssignmentsData);
            
            if (assignedFilesData) {
                console.log('assignedFiles size:', (assignedFilesData.length / 1024).toFixed(2), 'KB');
                console.log('assignedFiles contents:', JSON.parse(assignedFilesData));
            }
            
            if (fileAssignmentsData) {
                console.log('fileAssignments:', JSON.parse(fileAssignmentsData));
            }
            
            // Update dynamic tiles
            updateDashboardTiles();
            
            loadAssignedFiles();
        }

        function updateDashboardTiles() {
            const assignedFiles = JSON.parse(localStorage.getItem('assignedFiles')) || {};
            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            
            // Count files assigned to current user
            let myFileCount = 0;
            let lastFile = 'None';
            let newCount = 0;
            const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            
            for (const [fileName, fileContent] of Object.entries(assignedFiles)) {
                const assignmentData = fileAssignments[fileName];
                let assignedTo = [];
                
                // Handle both formats
                if (Array.isArray(assignmentData)) {
                    assignedTo = assignmentData;
                } else if (assignmentData && assignmentData.assignedTo) {
                    assignedTo = assignmentData.assignedTo;
                }
                
                if (assignedTo.includes(currentUser.user_id) || assignedTo.includes('all')) {
                    myFileCount++;
                    lastFile = fileName;
                    
                    // Check if assigned in last 7 days (approximate)
                    if (fileContent.timestamp && fileContent.timestamp > oneWeekAgo) {
                        newCount++;
                    }
                }
            }
            
            // Update tiles
            document.getElementById('totalAssignedFiles').textContent = myFileCount;
            document.getElementById('lastViewedFile').textContent = lastFile.length > 20 ? lastFile.substring(0, 17) + '...' : lastFile;
            document.getElementById('newAssignments').textContent = newCount;
            
            // Extract department from user_id (e.g., SCD_CIS -> CIS)
            let department = currentUser.user_id;
            if (currentUser.user_id.includes('_')) {
                department = currentUser.user_id.split('_')[1];
            }
            document.getElementById('userDepartment').textContent = department;
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function showBusinessFolderView() {
            document.getElementById('businessFolderView').style.display = 'block';
            document.getElementById('businessFileView').style.display = 'none';
            
            // Update folder count from fileAssignments
            const assignedFiles = JSON.parse(localStorage.getItem('assignedFiles')) || {};
            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            
            let myFileCount = 0;
            for (const [fileName, fileContent] of Object.entries(assignedFiles)) {
                const assignmentData = fileAssignments[fileName];
                let assignedTo = [];
                
                // Handle both formats
                if (Array.isArray(assignmentData)) {
                    assignedTo = assignmentData;
                } else if (assignmentData && typeof assignmentData === 'object') {
                    assignedTo = assignmentData.assignedTo || [];
                }
                
                if (assignedTo.includes(currentUser.user_id) || assignedTo.includes('all')) {
                    myFileCount++;
                }
            }
            
            document.getElementById('businessFolderCount').textContent = `${myFileCount} file${myFileCount !== 1 ? 's' : ''} assigned`;
        }

        function showBusinessFileView() {
            document.getElementById('businessFolderView').style.display = 'none';
            document.getElementById('businessFileView').style.display = 'block';
            
            const assignedFiles = JSON.parse(localStorage.getItem('assignedFiles')) || {};
            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            
            console.log('Opening uploads folder...');
            console.log('Files in storage:', Object.keys(assignedFiles));
            console.log('Assignments:', fileAssignments);
            
            loadBusinessFiles();
        }

        function loadAssignedFiles() {
            showBusinessFolderView();
        }

        // Global variable to store all user files
        let allUserFiles = [];
        let currentFrequencyFilter = 'all';

        function loadBusinessFiles() {
            const assignedFiles = JSON.parse(localStorage.getItem('assignedFiles')) || {};
            const fileAssignments = JSON.parse(localStorage.getItem('fileAssignments')) || {};
            
            console.log('=== Business User File Loading ===');
            console.log('Current user:', currentUser.user_id);
            console.log('assignedFiles in localStorage:', assignedFiles);
            console.log('fileAssignments in localStorage:', fileAssignments);
            
            // Get all files assigned to current user
            const myFiles = [];
            for (const [fileName, fileContent] of Object.entries(assignedFiles)) {
                const assignmentData = fileAssignments[fileName];
                let assignedTo = [];
                let frequency = 'monthly';
                
                // Handle both old array format and new object format
                if (Array.isArray(assignmentData)) {
                    assignedTo = assignmentData;
                } else if (assignmentData && typeof assignmentData === 'object') {
                    assignedTo = assignmentData.assignedTo || [];
                    frequency = assignmentData.frequency || 'monthly';
                }
                
                console.log(`Checking ${fileName}:`);
                console.log(`  - assignmentData type:`, typeof assignmentData);
                console.log(`  - assignmentData value:`, assignmentData);
                console.log(`  - assignedTo (parsed):`, assignedTo);
                console.log(`  - frequency:`, frequency);
                console.log(`  - Is array?`, Array.isArray(assignedTo));
                console.log(`  - Includes user?`, Array.isArray(assignedTo) && assignedTo.includes(currentUser.user_id));
                console.log(`  - Includes 'all'?`, Array.isArray(assignedTo) && assignedTo.includes('all'));
                
                // Check if user is explicitly assigned or if 'all' is in the array
                if (Array.isArray(assignedTo) && (assignedTo.includes(currentUser.user_id) || assignedTo.includes('all'))) {
                    console.log(`‚úì ${fileName} is assigned to ${currentUser.user_id}`);
                    myFiles.push({
                        fileName: fileName,
                        filePath: fileContent.filePath || `uploads/${fileName}`,
                        base64Data: fileContent.base64Data,
                        size: fileContent.size,
                        fileType: fileName.split('.').pop().toLowerCase(),
                        assignedTo: assignedTo,
                        frequency: frequency
                    });
                } else {
                    console.log(`‚úó ${fileName} is NOT assigned to ${currentUser.user_id}`);
                }
            }
            
            // Store globally for filtering
            allUserFiles = myFiles;
            
            console.log('Total files for this user:', myFiles.length);
            
            const filesList = document.getElementById('filesList');
            const frequencyTabs = document.getElementById('frequencyTabs');
            
            if (myFiles.length === 0) {
                filesList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="45" stroke="#ddd" stroke-width="3"/>
                            <path d="M30 50 L45 65 L70 35" stroke="#ddd" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h3 style="color: #999; margin-bottom: 10px;">No Files Assigned Yet</h3>
                        <p style="color: #bbb;">Files assigned to you by Master users will appear here</p>
                    </div>
                `;
                frequencyTabs.style.display = 'none';
                return;
            }
            
            // Show frequency tabs
            frequencyTabs.style.display = 'flex';
            
            // Update frequency counts
            updateFrequencyCounts(myFiles);
            
            // Render files with current filter
            renderFilteredFiles();
        }
        
        function updateFrequencyCounts(files) {
            const counts = {
                all: files.length,
                daily: 0,
                weekly: 0,
                monthly: 0,
                quarterly: 0,
                semi: 0,
                annually: 0
            };
            
            files.forEach(file => {
                if (counts.hasOwnProperty(file.frequency)) {
                    counts[file.frequency]++;
                }
            });
            
            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countDaily').textContent = counts.daily;
            document.getElementById('countWeekly').textContent = counts.weekly;
            document.getElementById('countMonthly').textContent = counts.monthly;
            document.getElementById('countQuarterly').textContent = counts.quarterly;
            document.getElementById('countSemi').textContent = counts.semi;
            document.getElementById('countAnnually').textContent = counts.annually;
        }
        
        function filterByFrequency(frequency) {
            currentFrequencyFilter = frequency;
            
            // Update active tab
            document.querySelectorAll('.frequency-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.frequency-tab.${frequency}`).classList.add('active');
            
            // Render filtered files
            renderFilteredFiles();
        }
        
        function renderFilteredFiles() {
            const filesList = document.getElementById('filesList');
            
            // Filter files based on current frequency
            let filteredFiles = allUserFiles;
            if (currentFrequencyFilter !== 'all') {
                filteredFiles = allUserFiles.filter(f => f.frequency === currentFrequencyFilter);
            }
            
            if (filteredFiles.length === 0) {
                filesList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                        <h3 style="color: #999; margin-bottom: 10px;">No ${currentFrequencyFilter === 'all' ? '' : currentFrequencyFilter.charAt(0).toUpperCase() + currentFrequencyFilter.slice(1)} dashboards</h3>
                        <p style="color: #bbb;">Try selecting a different frequency</p>
                    </div>
                `;
                return;
            }

            // Create card grid layout
            const cardGrid = document.createElement('div');
            cardGrid.className = 'dashboard-grid';
            
            filteredFiles.forEach(file => {
                const icon = getFileIcon(file.fileType);
                const fileId = file.fileName;
                const fileSizeFormatted = formatFileSize(file.size);
                
                // Determine file category for styling
                let fileCategory = 'other';
                let badgeClass = 'badge-csv';
                if (file.fileType === 'html') {
                    fileCategory = 'html';
                    badgeClass = 'badge-html';
                } else if (file.fileType === 'xlsx' || file.fileType === 'xls') {
                    fileCategory = 'excel';
                    badgeClass = 'badge-excel';
                } else if (file.fileType === 'pdf') {
                    fileCategory = 'pdf';
                    badgeClass = 'badge-pdf';
                } else if (file.fileType === 'csv') {
                    fileCategory = 'csv';
                    badgeClass = 'badge-csv';
                }
                
                const card = document.createElement('div');
                card.className = `dashboard-card ${fileCategory}`;
                card.ondblclick = () => viewAssignedFile(fileId);
                card.title = 'Double-click to open';
                
                card.innerHTML = `
                    <div class="dashboard-icon">${icon}</div>
                    <div class="dashboard-name">${file.fileName}</div>
                    <div class="dashboard-meta">
                        <span class="file-type-badge ${badgeClass}">${file.fileType.toUpperCase()}</span>
                        <span class="dashboard-size">${fileSizeFormatted}</span>
                    </div>
                    <div style="font-size: 12px; color: #28a745; margin-bottom: 8px; font-weight: 600;">
                        ‚úì Assigned to you
                    </div>
                    <div class="dashboard-actions">
                        <button class="card-btn primary" onclick="event.stopPropagation(); viewAssignedFile('${fileId}')">üëÅÔ∏è View</button>
                        <button class="card-btn secondary" onclick="event.stopPropagation(); downloadAssignedFile('${fileId}')">‚¨áÔ∏è Download</button>
                    </div>
                `;
                
                cardGrid.appendChild(card);
            });
            
            filesList.innerHTML = '';
            filesList.appendChild(cardGrid);
        }

        function getFileIcon(fileType) {
            const icons = {
                'xlsx': 'üìä',
                'xls': 'üìä',
                'csv': 'üìÑ',
                'html': 'üåê',
                'pdf': 'üìï',
                'txt': 'üìù',
                'json': 'üìã'
            };
            return icons[fileType] || 'üìÅ';
        }

        function getCategoryLabel(category) {
            const labels = {
                'sap_export': 'SAP Export',
                'financial': 'Financial',
                'dashboard_template': 'Dashboard',
                'analytics': 'Analytics',
                'raw_data': 'Raw Data',
                'other': 'Other'
            };
            return labels[category] || category;
        }

        function formatDateTime(timestamp, format) {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            let dateStr;
            if (format === 'MM/DD/YYYY') {
                dateStr = `${month}/${day}/${year}`;
            } else if (format === 'YYYY-MM-DD') {
                dateStr = `${year}-${month}-${day}`;
            } else {
                dateStr = `${day}/${month}/${year}`;
            }
            
            return `${dateStr} ${hours}:${minutes}`;
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function viewAssignedFile(fileName) {
            const assignedFiles = JSON.parse(localStorage.getItem('assignedFiles')) || {};
            const file = assignedFiles[fileName];
            
            if (!file) {
                alert('‚ùå File not found or access denied!');
                return;
            }

            const fileType = fileName.split('.').pop().toLowerCase();
            
            // Check if this is a physical file
            if (file.isPhysicalFile || !file.base64Data) {
                // Open physical file directly from uploads folder
                const filePath = file.filePath || `uploads/${fileName}`;
                window.open(filePath, '_blank');
            } else {
                // Handle base64 encoded files (legacy)
                if (fileType === 'html') {
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(atob(file.base64Data.split(',')[1]));
                    newWindow.document.close();
                } else if (fileType === 'txt' || fileType === 'csv') {
                    const content = atob(file.base64Data.split(',')[1]);
                    const preview = content.substring(0, 500) + (content.length > 500 ? '...' : '');
                    alert(`üìÑ File Preview: ${fileName}\n\n${preview}\n\n(Use Download button for full file)`);
                } else {
                    alert(`üëÅÔ∏è Preview not available for ${fileType.toUpperCase()} files.\n\nUse the Download button to save the file.`);
                }
            }
        }

        function downloadAssignedFile(fileName) {
            const assignedFiles = JSON.parse(localStorage.getItem('assignedFiles')) || {};
            const file = assignedFiles[fileName];
            
            if (!file) {
                alert('‚ùå File not found or access denied!');
                return;
            }

            const link = document.createElement('a');
            // For physical files, use the file path; for base64, use the data
            if (file.isPhysicalFile || !file.base64Data) {
                link.href = file.filePath || `uploads/${fileName}`;
            } else {
                link.href = file.base64Data;
            }
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Download Started!\n\nFile: ${fileName}\nSize: ${formatFileSize(file.size)}`);
        }
    </script>
</body>
</html>